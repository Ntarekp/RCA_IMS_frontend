name: Deploy RCA IMS Frontend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Inject env
        run: |
          # Use the repository's .env.production if available, or fall back to server config
          # We prefer .env.production for VITE_API_URL settings
          if [ -f .env.production ]; then
             echo "Using .env.production from repository"
             cp .env.production .env
          elif [ -f /opt/configs/rca-frontend/.env ]; then
             echo "Using server .env"
             cp /opt/configs/rca-frontend/.env .env
          else
             echo "No .env found!"
          fi

      - name: Install dependencies
        run: npm install

      - name: Build frontend
        run: npm run build

      - name: Cleanup env
        run: rm -f .env

      - name: Deploy build
        run: |
          rm -rf /opt/apps/rca-frontend/*
          cp -r dist/* /opt/apps/rca-frontend/

      - name: Restart frontend
        run: |
          pm2 delete rca-frontend || true
          pm2 start serve --name rca-frontend -- -s /opt/apps/rca-frontend -l 3000
          pm2 save
          sleep 5
          pm2 list
          pm2 logs rca-frontend --lines 20 --nostream
          ss -tuln